<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GTFS-RT Map with MapLibre</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; }
    #map { width: 100vw; height: 100vh; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://demotiles.maplibre.org/style.json', // OSMベースのスタイル
      center: [140.467, 37.75], // 福島付近
      zoom: 13
    });

    async function fetchBusData() {
      const proxyUrl = 'https://yourworker.youraccount.workers.dev'; // ← ここを自分のWorkerのURLに
      const proxyUrl = 'https://morning-sun-eb88.fujimaru703.workers.dev/'; // ← ここを自分のWorkerのURLに

      const response = await fetch(proxyUrl);
      const arrayBuffer = await response.arrayBuffer();

      // GTFS-RTのprotobufをブラウザで解析するには protobuf.js などが必要
      // 今回は仮にサーバー側でJSONに変換済みとし、形式を以下のように想定:
      // [{ id: '1234', latitude: 37.76, longitude: 140.45, label: 'Bus 1' }, ...]

      // ↓ここでは JSON 形式で受け取る場合の例（Workerで変換してる場合）
      // const data = await response.json();

      // ↓ここではGTFS-RTをバイナリのまま受け取る場合（protobuf.jsで解析）
      console.warn("ブラウザでバイナリのGTFS-RTを解析するにはprotobuf.jsなどが必要です");

      // 仮に座標配列を直接定義（実際はデコード後に以下の形式を生成）
      const mockData = [
        { id: "bus1", latitude: 37.76, longitude: 140.45, label: "Bus 1" },
        { id: "bus2", latitude: 37.75, longitude: 140.46, label: "Bus 2" }
      ];

      for (const vehicle of mockData) {
        new maplibregl.Marker({ color: "#FF0000" })
          .setLngLat([vehicle.longitude, vehicle.latitude])
          .setPopup(new maplibregl.Popup().setText(vehicle.label))
          .addTo(map);
      }
    }

    map.on('load', fetchBusData);
  </script>
</body>
</html>
