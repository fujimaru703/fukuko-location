
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <link href="icon-24x24.png" rel="icon"/>
  <title>福島交通ロケーションマップ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-easybutton/src/easy-button.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    footer {
      position: relative;
      height: 25px;
      background-color: #333;
      color: white;
      padding: 10px;
    }
    #timestampDisplay {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 5px 10px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      font-size: 11px;
      border-radius: 5px;
      z-index: 9999;
      white-space: nowrap;
    }
  </style>
</head>
<body>
<header><div>福島交通ロケーションマップ</div></header>
<div id="map"></div>
<footer><div id="timestampDisplay">最終更新: <span id="readableTimestamp"></span></div></footer>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://unpkg.com/leaflet-easybutton/src/easy-button.js"></script>

<script>
const map = L.map('map').setView([37.75, 140.47], 13);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
const topo = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
  attribution: '&copy; 国土地理院'
});
const gsi = L.tileLayer('https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}', {
  attribution: "Google Map"
});
const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; Carto | &copy; OpenStreetMap contributors'
});
const baseMaps = {
  "OpenStreetMap": osm,
  "地理院地図": topo,
  "Googlemap": gsi,
  "夜間地図": dark
};
L.control.layers(baseMaps, null, { position: 'bottomright' }).addTo(map);

let heatmapVisible = true;
let heatLayer;
let tripDelays = {};
let markers = [];
const labelIconMap = new Map();

const label290 = ['2007','8015','8016','8037','8038','8057','8058','8059','8077','8078','8079','8081','8101','8102','0873','0874','8127','8137','8138','8139','8140','8141','8143','8144','8145','8146','2006','0741','0743','0744','0774','0775','0803','8060','8061','7165','8080','80801','8098','8099','8100','8128','8129','8156','8157','8158','0887','0889'];
label290.forEach(label => labelIconMap.set(label, 'icon/290.png'));
const label557 = ['0557','2411','2412'];
label557.forEach(label => labelIconMap.set(label, 'icon/557&2411.png'));
const label600 = ['0600'];
label600.forEach(label => labelIconMap.set(label, 'icon/600.png'));

function createBusIcon(label, zoom) {
  const size = Math.max(32, Math.min(48, Math.round(32 * Math.pow(1.2, zoom - 13))));
  const iconUrl = labelIconMap.get(label) || 'icon/yokokamo.png';
  return L.icon({
    iconUrl: iconUrl,
    iconSize: [size, size],
    iconAnchor: [size / 2, size / 2],
    popupAnchor: [0, -size / 2]
  });
}

L.easyButton({
  states: [{
    stateName: 'toggle-heatmap',
    icon: 'fa-solid fa-fire',
    title: 'ヒートマップ切替',
    onClick: function(btn, map) {
      if (heatLayer) {
        if (map.hasLayer(heatLayer)) {
          map.removeLayer(heatLayer);
          heatmapVisible = false;
        } else {
          heatLayer.addTo(map);
          heatmapVisible = true;
        }
      }
    }
  }]
}).addTo(map);

async function loadDelays() {
  const res = await fetch('https://crimson-night-b53e.fujimaru703.workers.dev/');
  const data = await res.json();
  tripDelays = {};
  for (const entity of data.entity) {
    const trip = entity?.tripUpdate?.trip;
    const updates = entity?.tripUpdate?.stopTimeUpdate;
    if (trip && updates?.length > 0) {
      let maxDelay = 0;
      for (const update of updates) {
        const d = update?.departure?.delay || update?.arrival?.delay || 0;
        if (typeof d === 'number' && d > maxDelay) {
          maxDelay = d;
        }
      }
      if (maxDelay >= 300) {
        tripDelays[trip.tripId] = maxDelay;
      }
    }
  }
}

async function showDelayedBusHeatmap() {
  const res = await fetch('https://morning-sun-eb88.fujimaru703.workers.dev/');
  const data = await res.json();
  const delayPoints = [];

  for (const entity of data.entity) {
    const vehicle = entity.vehicle;
    const pos = vehicle?.position;
    const tripId = vehicle?.trip?.tripId;
    const delaySec = tripDelays[tripId];
    if (pos && typeof delaySec === 'number' && delaySec >= 300) {
      const weight = Math.min(delaySec / 60, 20);
      delayPoints.push([pos.latitude, pos.longitude, weight]);
    }
  }

  if (heatLayer) map.removeLayer(heatLayer);
  heatLayer = L.heatLayer(delayPoints, {
    radius: 30,
    blur: 15,
    maxZoom: 15
  });

  if (heatmapVisible) {
    heatLayer.addTo(map);
  }
}

function updateTimestamp() {
  const now = new Date();
  document.getElementById('readableTimestamp').textContent = now.toLocaleString('ja-JP');
}

async function updateAll() {
  await loadDelays();
  await showDelayedBusHeatmap();
  updateTimestamp();
}

window.addEventListener('load', () => {
  updateAll();
  setInterval(updateAll, 15000);
});
</script>
</body>
</html>
